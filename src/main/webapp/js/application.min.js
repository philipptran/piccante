crossroads.addRoute("/", function() {
  hasher.setHash("/home");
});

crossroads.addRoute("/home", function() {
  ko.Piccante._App.NavBar.activeView(ko.Piccante._App.NavBar.VIEWS[0]);
  ko.Piccante._App.render(new ko.Piccante.vm.PageHomeVM());
});

crossroads.addRoute("/team", function() {
  ko.Piccante._App.NavBar.activeView(ko.Piccante._App.NavBar.VIEWS[3]);
  ko.Piccante._App.render(new ko.Piccante.vm.PageTeamVM());
});

crossroads.addRoute("/jobs", function() {
  ko.Piccante._App.NavBar.activeView(ko.Piccante._App.NavBar.VIEWS[4]);
  ko.Piccante._App.render(new ko.Piccante.vm.PageJobsVM());
});

crossroads.addRoute("/contact", function() {
  ko.Piccante._App.NavBar.activeView(ko.Piccante._App.NavBar.VIEWS[5]);
  ko.Piccante._App.render(new ko.Piccante.vm.PageContactVM());
});

ko.Piccante = {
  conf: {},
  vm: {}
};

hasher.initialized.add(function(h) {
  crossroads.parse(h);
  console.log("Initial Route: ", h);
});

hasher.changed.add(function(h) {
  crossroads.parse(h);
  console.log("Changed Route to: ", h);
});

$(function() {
  console.log("Coming in");
  ko.Piccante._App = new ko.Piccante.vm.AppVM();
  ko.applyBindings(ko.Piccante._App);
  hasher.init();
});

ko.Piccante.vm.AppVM = function() {
  console.log("AppVM on init: ", true);
  var self = this;
  var _routeNode = $(".routeNode");
  self.NavBar = new ko.Piccante.vm.NavBarVM();
  self.render = function(vm) {
    console.log("Start to render the content");
    ko.cleanNode(_routeNode[0]);
    _routeNode.empty();
    if (vm && vm.render) {
      vm.render(_routeNode);
    }
  };
  ko.Piccante.vm.BaseVM.apply(self);
};

ko.Piccante.vm.BaseVM = function() {
  var self = this;
  self.applyBindings = function(templateName, target) {
    var deferred = $.Deferred();
    ko.renderTemplate(templateName, self, {
      afterRender: function() {
        console.log("-- Rendered following template: ", templateName);
        deferred.resolve();
      }
    }, target[0]);
    return deferred.promise();
  };
  self.loadTemplate = function(templateName) {
    var deferred = $.Deferred();
    if ($("#" + templateName).length > 0) {
      deferred.resolve(templateName);
    } else {
      $.ajax({
        url: "/assets/templates/" + templateName + ".html"
      }).then(function(template) {
        $("body").append($("<script>", {
          id: templateName,
          type: "text/html",
          text: template
        }));
        deferred.resolve(templateName);
      }, function() {
        deferred.reject;
      });
    }
    return deferred.promise();
  };
};

ko.Piccante.vm.NavBarVM = function() {
  console.log("NavBarVM on Init: ", true);
  var self = this;
  self.VIEWS = [ "home", "offer", "sick", "team", "jobs", "contact" ];
  self.activeView = ko.observable("");
  ko.Piccante.vm.BaseVM.apply(self);
};

ko.Piccante.vm.PageContactVM = function() {
  var self = this;
  var _conf = {
    template: "pc-template"
  };
  self.render = function(node) {
    self.loadTemplate(_conf.template).then(function(templateName) {
      self.applyBindings(templateName, node);
    });
  };
  ko.Piccante.vm.BaseVM.apply(self);
};

ko.Piccante.vm.PageHomeVM = function() {
  console.log("Im the PageHomeMV");
  var self = this;
  var _conf = {
    template: "ph-template"
  };
  self.render = function(node) {
    self.loadTemplate(_conf.template).then(function(templateName) {
      self.applyBindings(templateName, node);
    });
  };
  ko.Piccante.vm.BaseVM.apply(self);
};

ko.Piccante.vm.PageJobsVM = function() {
  var self = this;
  var _conf = {
    templateName: "pj-template"
  };
  self.render = function(node) {
    self.loadTemplate(_conf.templateName).then(function(templateName) {
      self.applyBindings(templateName, node);
    });
  };
  ko.Piccante.vm.BaseVM.apply(self);
};

ko.Piccante.vm.PageTeamVM = function() {
  console.log("This is the Team Page");
  var self = this;
  var _conf = {
    template: "pt-template"
  };
  self.render = function(node) {
    self.loadTemplate(_conf.template).then(function(templateName) {
      self.applyBindings(templateName, node);
    });
  };
  ko.Piccante.vm.BaseVM.apply(self);
};